{# templates/people/perfil_usuario.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Perfil-Usuario{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'people/css/perfiles.css' %}">
{% endblock %}

{% block content %}
<div class="aa-container">
  <div class="aa-toolbar">
    <h2>Perfil-Usuario</h2>
  </div>

  <section class="perfil-header">
    <div class="perfil-box">
      <div class="perfil-left">

        <!-- ==== AVATAR PERFIL ==== -->
        <div class="p-avatar-wrapper">
          <div class="p-avatar">
            {% if request.user.imagen_perfil %}
              <img id="pAvatarImg" src="{{ request.user.imagen_perfil.url }}" alt="Avatar de {{ request.user.get_full_name|default:request.user.username }}">
            {% else %}
              <img id="pAvatarImg" src="{% static 'people/inge.jpg' %}" alt="Avatar por defecto">
            {% endif %}
          </div>
          <button type="button" class="p-avatar-edit-btn" id="pOpenAvatarModal" aria-label="Cambiar foto de perfil">+</button>
        </div>
        <!-- ==== FIN AVATAR PERFIL ==== -->

        <div class="alumno">
          <div class="label">Alumno: {{ request.user.get_full_name }}</div>
          <div class="value">{{ request.user.username }}</div>
        </div>

        <div class="perfil-left-extra">
          <div class="carrera">Ing en Sistemas de información</div>
          <div class="promedio">
            <span>Promedio:</span>
            {% if promedio is not None %}
              <span class="value">{{ promedio|floatformat:2 }}</span>
            {% else %}
              <span class="value">—</span>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </section>

  <section class="section-card">
    <h3>Evaluar Materias:</h3>
    {% if mcas_para_evaluar %}
      <div class="chip-list">
        {% for mca in mcas_para_evaluar %}
          <a class="chip" href="{% url 'academics:evaluar_mca' mca.id %}">
            {{ mca.materia.nombre }} — {{ mca.comision.nombre }} ({{ mca.anio }})
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty muted">No hay materias para evaluar en este momento.</div>
    {% endif %}
  </section>

  <section class="comentarios-card section-card">
    <div class="comentarios-head">
      <h3>Mis Comentarios <span class="count">{{ comentarios_total }}</span></h3>

      <div class="filter-menu">
        <details class="filter">
          <summary class="filter-chip">
            Filtrar <span class="caret"></span>
          </summary>
          <div class="filter-popover">
            <a class="filter-item {% if orden == 'desc' %}active{% endif %}" href="?orden=desc">Más recientes</a>
            <a class="filter-item {% if orden == 'asc' %}active{% endif %}" href="?orden=asc">Más antiguos</a>
          </div>
        </details>
      </div>
    </div>

    {% if comentarios_todos %}
      {% for c in comentarios_todos %}
        <div class="comentario-item">
          <div class="com-header">
            <span class="badge {{ c.badge }}">{{ c.tipo }}</span>
            <span class="title">{{ c.title }}</span>
            <span class="subtitle">· {{ c.subtitle }}</span>
          </div>

          <div class="meta">
            <div class="rating">
              {% for i in "12345" %}
                <span class="star{% if forloop.counter <= c.puntuacion %} on{% endif %}">★</span>
              {% endfor %}
              <span class="score">{{ c.puntuacion }}</span>
            </div>
            <div>{{ c.fecha|date:"d/m/Y" }}</div>
          </div>

          <div class="comentario">
            {{ c.comentario|default:"Sin comentario." }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty">No tenés reseñas todavía.</div>
    {% endif %}
  </section>
</div>

<!-- ==== MODAL CAMBIAR AVATAR ==== -->
<div class="p-modal-backdrop" id="pAvatarModal" hidden style="display:none">
  <div class="p-modal">
    <div class="p-modal-header">
      <h4>Cambiar foto de perfil</h4>
      <button type="button" class="p-modal-close" id="pCloseAvatarModal" aria-label="Cerrar">×</button>
    </div>

    <form id="pAvatarForm" method="post" action="{% url 'people:upload_avatar' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="p-modal-body">
        <div class="p-avatar-preview">
          <img id="pAvatarPreview" src="{% if request.user.imagen_perfil %}{{ request.user.imagen_perfil.url }}{% else %}{% static 'people/inge.jpg' %}{% endif %}" alt="Previsualización">
        </div>

        <div class="p-file-field">
          <label for="pAvatarInput" class="p-file-label">Elegir nueva foto</label>
          <input type="file" id="pAvatarInput" name="imagen" accept="image/*" class="p-visually-hidden">
          <small class="p-muted">Formatos: JPG/PNG/WebP. Máx: 5 MB.</small>
        </div>
      </div>

      <div class="p-modal-footer">
        <button type="button" class="p-btn p-secondary" id="pCancelAvatar">Cancelar</button>
        <button type="submit" class="p-btn p-primary" id="pSaveAvatar">Aceptar</button>
      </div>
    </form>
  </div>
</div>
<!-- ==== FIN MODAL ==== -->

{% block extra_js %}
<script>
(function(){
  const backdrop = document.getElementById('pAvatarModal');
  const openBtn  = document.getElementById('pOpenAvatarModal');
  const closeBtn = document.getElementById('pCloseAvatarModal');
  const cancelBtn= document.getElementById('pCancelAvatar');
  const input    = document.getElementById('pAvatarInput');
  const preview  = document.getElementById('pAvatarPreview');
  const form     = document.getElementById('pAvatarForm');
  const saveBtn  = document.getElementById('pSaveAvatar');

  // Estado inicial cerrado
  function ensureClosed(){
    backdrop.hidden = true;
    backdrop.style.display = 'none';
    document.body.style.overflow = '';
  }
  ensureClosed();

  function openModal(){
    backdrop.hidden = false;
    backdrop.style.display = 'grid';
    document.body.style.overflow = 'hidden';
  }
  function closeModal(){
    ensureClosed();
  }

  openBtn?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', (e) => {
    if (e.target === backdrop) closeModal();
  });

  input?.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const ok = ['image/jpeg','image/png','image/webp'];
    if (!ok.includes(file.type)) { alert('Formato no soportado. Usa JPG, PNG o WebP.'); input.value=''; return; }
    if (file.size > 5 * 1024 * 1024) { alert('La imagen supera 5 MB.'); input.value=''; return; }

    const reader = new FileReader();
    reader.onload = ev => { preview.src = ev.target.result; };
    reader.readAsDataURL(file);
  });

  form?.addEventListener('submit', () => {
    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';
  });
})();
</script>
{% endblock %}
{% endblock %}
