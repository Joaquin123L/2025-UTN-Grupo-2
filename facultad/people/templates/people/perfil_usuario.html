{% extends "base.html" %}
{% load static %}

{% block title %}Perfil-Usuario{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'people/css/perfiles.css' %}">
<style>
/* ===== MODAL DE CONFIRMACIÓN ELEGANTE ===== */
.confirm-modal {
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(2px);
  z-index: 9999;
}
.confirm-box {
  background: #fff;
  border-radius: 20px;
  padding: 28px 34px;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
  text-align: center;
  max-width: 380px;
  animation: fadeIn 0.25s ease-out;
}
.confirm-text {
  font-size: 18px;
  color: #111;
  margin: 0 0 10px;
  font-weight: 600;
}
.confirm-text small {
  display: block;
  color: #6b7280;
  margin-top: 6px;
  font-size: 14px;
}
.confirm-actions {
  display: flex;
  justify-content: center;
  gap: 14px;
  margin-top: 22px;
}
.confirm-btn {
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  padding: 10px 22px;
  cursor: pointer;
  transition: all 0.15s ease;
}
.confirm-btn.cancel {
  background: #f8f9fa;
  color: #374151;
  border: 1px solid #e5e7eb;
}
.confirm-btn.cancel:hover {
  background: #e5e7eb;
}
.confirm-btn.delete {
  background: #e53935;
  color: #fff;
}
.confirm-btn.delete:hover {
  background: #d32f2f;
  transform: translateY(-1px);
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== ICONOS ===== */
.icon-22 {
  width: 22px;
  height: 22px;
  object-fit: contain;
  transition: transform 0.15s ease, opacity 0.15s ease;
}
.icon-22:hover {
  transform: scale(1.15);
  opacity: 0.85;
}

/* ===== POSICIÓN ===== */
.com-actions {
  position: absolute;
  bottom: 10px;
  right: 12px;
  display: flex;
  gap: 12px;
}
.comentario-item {
  position: relative;
  padding-bottom: 40px;
}
</style>
{% endblock %}

{% block content %}
<div class="aa-container">
  <div class="aa-toolbar">
    <h2>Perfil-Usuario</h2>
  </div>

  <section class="perfil-header">
    <div class="perfil-box">
      <div class="perfil-left">
        <div class="p-avatar-wrapper">
          <div class="p-avatar">
            {% if request.user.imagen_perfil %}
              <img id="pAvatarImg" src="{{ request.user.imagen_perfil.url }}" alt="Avatar de {{ request.user.get_full_name|default:request.user.username }}">
            {% else %}
              <img id="pAvatarImg" src="{% static 'people/inge.jpg' %}" alt="Avatar por defecto">
            {% endif %}
          </div>
          <button type="button" class="p-avatar-edit-btn" id="pOpenAvatarModal" aria-label="Cambiar foto de perfil">+</button>
        </div>

        <div class="alumno">
          <div class="label">Alumno: {{ request.user.get_full_name }}</div>
          <div class="value">{{ request.user.username }}</div>
        </div>

        <div class="perfil-left-extra">
  <div class="carrera">Ing en Sistemas de información</div>
  <div class="promedio">
    <span>Promedio:</span>
    {% if promedio is not None %}
      <span class="value">{{ promedio|floatformat:2 }}</span>
    {% else %}
      <span class="value">—</span>
    {% endif %}
  </div>
</div>

      </div>
      <!-- DERECHA: donut -->
      <div class="perfil-right">
        <div class="card-donut">
  <div id="donut-estado"></div>
</div>
      </div>
       </div>
      </section>
  <!-- ===== EVALUAR MATERIAS ===== -->
  <section class="section-card">
    <h3>Evaluar Materias:</h3>
    {% if mcas_para_evaluar %}
      <div class="chip-list">
        {% for mca in mcas_para_evaluar %}
          <a class="chip" href="{% url 'academics:evaluar_mca' mca.id %}">
            {{ mca.materia.nombre }} — {{ mca.comision.nombre }} ({{ mca.anio }})
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty muted">No hay materias para evaluar en este momento.</div>
    {% endif %}
  </section>

  <!-- ===== MIS COMENTARIOS ===== -->
  <section class="comentarios-card section-card">
    <div class="comentarios-head">
      <h3>Mis Comentarios <span class="count">{{ comentarios_total }}</span></h3>

      <div class="filter-menu">
        <details class="filter">
          <summary class="filter-chip">Filtrar <span class="caret"></span></summary>
          <div class="filter-popover">
            <a class="filter-item {% if orden == 'desc' %}active{% endif %}" href="?orden=desc">Más recientes</a>
            <a class="filter-item {% if orden == 'asc' %}active{% endif %}" href="?orden=asc">Más antiguos</a>
          </div>
        </details>
      </div>
    </div>

    {% if comentarios_todos %}
      {% for c in comentarios_todos %}
        <div class="comentario-item">
          <div class="com-header">
            <span class="badge {{ c.badge }}">{{ c.tipo }}</span>
            <span class="title">{{ c.title }}</span>
            <span class="subtitle">· {{ c.subtitle }}</span>
          </div>

          <div class="meta" style="display:flex;justify-content:space-between;align-items:center;margin-top:.4rem;">
            <div class="meta-date" style="color:var(--pp-muted);font-size:.9rem;">
              {{ c.fecha|date:"d/m/Y" }}
            </div>
            <div class="rating">
              {% for i in "12345" %}
                <span class="star{% if forloop.counter <= c.puntuacion %} on{% endif %}">★</span>
              {% endfor %}
              <span class="score">{{ c.puntuacion }}</span>
            </div>
          </div>

          <div class="comentario">{{ c.comentario|default:"Sin comentario." }}</div>

          {% if c.mca_id %}
          <div class="com-actions">
            <a href="{% url 'academics:editar_resena_mca' c.mca_id %}" title="Editar reseña">
              <img class="icon-22" src="{% static 'people/editarr.png' %}" alt="Editar">
            </a>
            <form class="delete-form" data-mca="{{ c.mca_id }}" method="post"
                  action="{% url 'academics:eliminar_resena_mca' c.mca_id %}">
              {% csrf_token %}
              <button type="button" class="delete-btn" title="Eliminar reseña"
                      style="background:none;border:none;cursor:pointer;padding:0;">
                <img class="icon-22" src="{% static 'people/eliminar.png' %}" alt="Eliminar">
              </button>
            </form>
          </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="empty">No tenés reseñas todavía.</div>
    {% endif %}
  </section>
  <!-- ===== /MIS COMENTARIOS ===== -->
</div>

<!-- Modal confirmación -->
<div id="confirmModal" class="confirm-modal" hidden>
  <div class="confirm-box">
    <p class="confirm-text">
      ¿Deseás borrar el comentario?
      <small>Se eliminará toda la reseña asociada.</small>
    </p>
    <div class="confirm-actions">
      <button id="confirmCancel" class="confirm-btn cancel">Cancelar</button>
      <button id="confirmOk" class="confirm-btn delete">Eliminar</button>
    </div>
  </div>
</div>



{% block extra_js %}
<script>
(function(){
  // Modal eliminar reseña
  const confirmModal = document.getElementById('confirmModal');
  const confirmCancel = document.getElementById('confirmCancel');
  const confirmOk = document.getElementById('confirmOk');
  let currentForm = null;

  document.querySelectorAll('.delete-form .delete-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.preventDefault();
      currentForm = btn.closest('form');
      confirmModal.hidden = false;
      confirmModal.style.display = 'grid';
      document.body.style.overflow = 'hidden';
    });
  });

  function closeModal(){
    confirmModal.hidden = true;
    confirmModal.style.display = 'none';
    document.body.style.overflow = '';
  }

  confirmCancel.addEventListener('click', closeModal);
  confirmModal.addEventListener('click', e=>{
    if(e.target===confirmModal) closeModal();
  });

  confirmOk.addEventListener('click', ()=>{
    if(currentForm){
      confirmOk.textContent = 'Eliminando...';
      confirmOk.disabled = true;
      currentForm.submit();
    }
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
(function () {
  const el = document.querySelector('#donut-estado');
  if (!el) return;

  const dataCounts = {
    promocionada: parseInt('{{ donut_counts.Promocionada|default:0 }}'),
    aprobada: parseInt('{{ donut_counts.Aprobada|default:0 }}'),
    pendientes: parseInt('{{ donut_counts.Pendientes|default:0 }}'),
  };

  const total = Object.values(dataCounts).reduce((a,b)=>a+b,0) || 1;

  // Tomar variables desde CSS (sin estilos hardcodeados en JS)
  const css = getComputedStyle(document.documentElement);
  const cssVar = (name, fallback='') => (css.getPropertyValue(name) || fallback).toString().trim();

  const COLORS = [
    cssVar('--color-promocionada', '#6BB9FF'),
    cssVar('--color-aprobada', '#F4C06A'),
    cssVar('--color-pendientes', '#F07557'),
  ];

  const labels = ['Promocionada','Aprobada','Pendientes'];
  const series = [
    dataCounts.promocionada,
    dataCounts.aprobada,
    dataCounts.pendientes
  ];

  const strokeWidth = Number(cssVar('--donut-border-w', '3')) || 8;

  const options = {
    chart: { type: 'donut', height: 260, fontFamily: 'inherit' },
    series,
    labels,
    colors: COLORS,
    stroke: { width: strokeWidth },
    legend: {
      show: true,
    },
    dataLabels: {
      enabled: false,
      formatter: function (val, opts) {
        const valAbs = opts.w.config.series[opts.seriesIndex] || 0;
        const pct = Math.round((valAbs * 100) / total);
        return pct + '%';
      },
      style: { fontSize: cssVar('--label-fs', '12px') }
    },
    plotOptions: {
      pie: {
        donut: {
          size: cssVar('--donut-cutout', '60%'),
          labels: {
            show: true,
            total: {
              show: true,
              label: 'Total',
              formatter: () => total
            }
          }
        }
      }
    },
    tooltip: {
      y: {
        formatter: function (val) {
          const pct = Math.round((val * 100) / total);
          return val + ' (' + pct + '%)';
        }
      }
    }
  };

  new ApexCharts(el, options).render();
})();
</script>
{% endblock %}
{% endblock %}
