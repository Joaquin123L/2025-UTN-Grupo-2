{% extends "base.html" %}
{% load static %}

{% block title %}Perfil-Usuario{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'people/css/perfiles.css' %}">
{% endblock %}

{% block content %}
<div class="aa-container">
  <div class="aa-toolbar">
    <h2>Perfil-Usuario</h2>
  </div>

  <section class="perfil-header">
    <div class="perfil-box">
      <div class="perfil-left">

        <div class="avatar">
          {% if request.user.imagen_perfil %}
            <img src="{{ request.user.imagen_perfil.url }}" alt="Avatar de {{ request.user.get_full_name|default:request.user.username }}">
          {% else %}
            <img src="{% static 'people/inge.jpg' %}" alt="Avatar por defecto">
          {% endif %}
        </div>

        <div class="alumno">
          <div class="label">Alumno: {{ request.user.get_full_name }}</div>
          <div class="value">{{ request.user.username }}</div>
        </div>

        <div class="perfil-left-extra">
          <div class="carrera">Ing en Sistemas de información</div>
          <div class="promedio">
            <span>Promedio:</span>
            {% if promedio is not None %}
              <span class="value">{{ promedio|floatformat:2 }}</span>
            {% else %}
              <span class="value">—</span>
            {% endif %}
          </div>
        </div>

      </div>
      <!-- DERECHA: donut -->
      <div class="perfil-right">
        <div class="donut-hero">
          <canvas id="estadoDonut" width="260" height="260"></canvas>
        </div>
      </div>
       </div>
      </section>
  <!-- ===== EVALUAR MATERIAS ===== -->
  <section class="section-card">
    <h3>Evaluar Materias:</h3>
    {% if mcas_para_evaluar %}
      <div class="chip-list">
        {% for mca in mcas_para_evaluar %}
          <a class="chip" href="{% url 'academics:evaluar_mca' mca.id %}">
            {{ mca.materia.nombre }} — {{ mca.comision.nombre }} ({{ mca.anio }})
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty muted">No hay materias para evaluar en este momento.</div>
    {% endif %}
  </section>

  <!-- ===== MIS COMENTARIOS ===== -->
  <section class="comentarios-card section-card">
    <div class="comentarios-head">
      <h3>Mis Comentarios <span class="count">{{ comentarios_total }}</span></h3>

      <div class="filter-menu">
        <details class="filter">
          <summary class="filter-chip">
            Filtrar <span class="caret"></span>
          </summary>
          <div class="filter-popover">
            <a class="filter-item {% if orden == 'desc' %}active{% endif %}" href="?orden=desc">Más recientes</a>
            <a class="filter-item {% if orden == 'asc' %}active{% endif %}" href="?orden=asc">Más antiguos</a>
          </div>
        </details>
      </div>
    </div>

    {% if comentarios_todos %}
      {% for c in comentarios_todos %}
        <div class="comentario-item">
          <div class="com-header">
            <span class="badge {{ c.badge }}">{{ c.tipo }}</span>
            <span class="title">{{ c.title }}</span>
            <span class="subtitle">· {{ c.subtitle }}</span>
          </div>

          <div class="meta">
            <div class="rating">
              {% for i in "12345" %}
                <span class="star{% if forloop.counter <= c.puntuacion %} on{% endif %}">★</span>
              {% endfor %}
              <span class="score">{{ c.puntuacion }}</span>
            </div>
            <div>{{ c.fecha|date:"d/m/Y" }}</div>
          </div>

          <div class="comentario">
            {{ c.comentario|default:"Sin comentario." }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty">No tenés reseñas todavía.</div>
    {% endif %}
  </section>
  <!-- ===== /MIS COMENTARIOS ===== -->
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
(function(){
  const el = document.getElementById('estadoDonut');
  if (!el) return;

  // Conteos por estado (vienen del backend)
  const dataCounts = {
    cursando: {{ donut_counts.Cursando|default:0|safe }},
    promocionada: {{ donut_counts.Promocionada|default:0|safe }},
    aprobada: {{ donut_counts.Aprobada|default:0|safe }},
    pendientes: {{ donut_counts.Pendientes|default:0|safe }},
  };

  const COLORS = {
    cursando: '#76D672',
    promocionada: '#6BB9FF',
    aprobada: '#F4C06A',
    pendientes: '#F07557',
    white: '#FFFFFF'
  };

  // Plugin para extremos redondeados
  const roundedDoughnut = {
    id: 'roundedDoughnut',
    afterDatasetDraw(chart, args) {
      const {ctx} = chart;
      const meta = args.meta;
      if (!meta.data) return;
      meta.data.forEach(arc => {
        const {x, y} = arc.getProps(['x','y'], true);
        const r = (arc.outerRadius + arc.innerRadius) / 2;
        const t = (arc.outerRadius - arc.innerRadius);
        const a0 = arc.startAngle;
        const a1 = arc.endAngle;
        ctx.save();
        ctx.translate(x, y);
        ctx.fillStyle = arc.options.backgroundColor;
        // inicio
        ctx.beginPath();
        ctx.arc(r*Math.cos(a0), r*Math.sin(a0), t/2, 0, Math.PI*2);
        ctx.fill();
        // fin
        ctx.beginPath();
        ctx.arc(r*Math.cos(a1), r*Math.sin(a1), t/2, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      });
    }
  };

  const chart = new Chart(el.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Cursando','Promocionada','Aprobada','Pendientes'],
      datasets: [{
        data: [
          dataCounts.cursando,
          dataCounts.promocionada,
          dataCounts.aprobada,
          dataCounts.pendientes
        ],
        backgroundColor: [
          COLORS.cursando,
          COLORS.promocionada,
          COLORS.aprobada,
          COLORS.pendientes
        ],
        borderColor: COLORS.white,
        borderWidth: 10,
        spacing: 6,
        cutout: '60%'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0) || 1;
              const val = ctx.parsed;
              const pct = Math.round(val*100/total);
              return ` ${ctx.label}: ${val} (${pct}%)`;
            }
          }
        }
      }
    },
    plugins: [roundedDoughnut]
  });

  // Si los porcentajes vienen mal del back, podés sincronizarlos con el gráfico:
  const total = Object.values(dataCounts).reduce((a,b)=>a+b,0) || 1;
  const pct = (v)=> Math.round((v*100)/total);
  const setTxt = (id, val)=>{ const n=document.getElementById(id); if(n) n.textContent = pct(val)+'%'; };
  setTxt('lbl-cursando', dataCounts.cursando);
  setTxt('lbl-promocionada', dataCounts.promocionada);
  setTxt('lbl-aprobada', dataCounts.aprobada);
  setTxt('lbl-pendientes', dataCounts.pendientes);
})();
</script>
{% endblock %}
{% endblock %}
