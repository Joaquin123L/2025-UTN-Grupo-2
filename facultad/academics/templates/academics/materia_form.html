{% extends "base.html" %}
{% load static %}
{% block title %}Materia: {{ view.object.nombre|default:"Nueva" }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'academics/css/materia_form.css' %}">
{% endblock %}

{% block content %}
<div class="ap-form-wrap">
  <h2 class="ap-title">Materia: {{ view.object.nombre|default:"Nueva" }}</h2>

  <div class="ap-card">
    <form method="post" id="matForm">
      {% csrf_token %}

      {% for f in form %}
        {% if f.name != 'eliminado' or view.object.pk %}
          <div class="ap-field">
            <label class="ap-label" for="{{ f.id_for_label }}">
              {{ f.label }} {% if f.field.required %}<span class="ap-required">*</span>{% endif %}
            </label>

            {# --- ICONO (SVG o URL) --- #}
            {% if f.name == 'icono' %}
              {{ f }}
              <div class="ap-help">
                Pegá el <strong>SVG inline</strong> o una <strong>URL</strong> a un SVG/imagen.
              </div>

            {# --- IMAGEN (solo URL, sin preview) --- #}
            {% elif f.name == 'imagen' %}
              {{ f }}
              <div class="ap-help">
                Pegá la <strong>URL</strong> de la imagen (JPG/PNG/SVG, etc.).
              </div>

            {# --- RESTO DE CAMPOS --- #}
            {% else %}
              {{ f }}
              {% if f.help_text %}
                <div class="ap-help">{{ f.help_text }}</div>
              {% endif %}
            {% endif %}

            {% if f.errors %}
              <div class="ap-errors">{{ f.errors }}</div>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      <div class="ap-actions">
        <a href="{% url 'academics:materia_list' %}" class="ap-btn ap-btn-light">Cancelar</a>
        <button class="ap-btn ap-btn-primary" id="btnSubmit" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // === marcar campos con error ===
  (function () {
    document.querySelectorAll('.ap-field').forEach(function (wrap) {
      if (wrap.querySelector('.ap-errors')) {
        const input = wrap.querySelector('input, select, textarea');
        if (input) input.classList.add('ap-invalid');
      }
    });
  })();

  // === autosize de textarea ===
  (function () {
    document.querySelectorAll('textarea').forEach(function (ta) {
      const fit = () => {
        ta.style.height = 'auto';
        ta.style.height = (ta.scrollHeight + 2) + 'px';
      };
      ta.addEventListener('input', fit);
      fit();
    });
  })();

  // === evitar doble submit ===
  (function () {
    const form = document.getElementById('matForm');
    const btn = document.getElementById('btnSubmit');
    if (!form || !btn) return;
    form.addEventListener('submit', function () {
      btn.disabled = true;
      btn.textContent = 'Guardando...';
    });
  })();
</script>
{% endblock %}
