{% extends "base.html" %}
{% load static %}
{% block title %}Materia: {{ view.object.nombre|default:"Nueva" }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'academics/css/materia_form.css' %}">
{% endblock %}

{% block content %}
<div class="ap-form-wrap">
  <h2 class="ap-title">Materia: {{ view.object.nombre|default:"Nueva" }}</h2>

  <div class="ap-card">
    <form method="post" id="matForm"
      action="{% if view.object.pk %}{% url 'academics:materia_update' view.object.pk %}
              {% else %}{% url 'academics:materia_create' %}{% endif %}">
      {% csrf_token %}

      <div class="ap-field">
        <label class="ap-label" for="{{ form.nombre.id_for_label }}">
          {{ form.nombre.label }}{% if form.nombre.field.required %}<span class="ap-required">*</span>{% endif %}
        </label>
        {{ form.nombre }}
        {% if form.nombre.errors %}<div class="ap-errors">{{ form.nombre.errors }}</div>{% endif %}
      </div>

      <div class="ap-field">
        <label class="ap-label" for="{{ form.departamento.id_for_label }}">
          {{ form.departamento.label }}{% if form.departamento.field.required %}<span class="ap-required">*</span>{% endif %}
        </label>
        {{ form.departamento }}
        {% if form.departamento.errors %}<div class="ap-errors">{{ form.departamento.errors }}</div>{% endif %}
      </div>

      <div class="ap-field">
        <label class="ap-label" for="{{ form.descripcion.id_for_label }}">
          {{ form.descripcion.label }}{% if form.descripcion.field.required %}<span class="ap-required">*</span>{% endif %}
        </label>
        {{ form.descripcion }}
        {% if form.descripcion.help_text %}<div class="ap-help">{{ form.descripcion.help_text }}</div>{% endif %}
        {% if form.descripcion.errors %}<div class="ap-errors">{{ form.descripcion.errors }}</div>{% endif %}
      </div>

      <hr>

     {# --- IMAGEN (URL) --- #}
<div class="ap-field">
  <label class="ap-label" for="{{ form.imagen_url.id_for_label }}">{{ form.imagen_url.label }}</label>
  {{ form.imagen_url }}
  <div class="ap-help">Pegá la <strong>URL</strong> de la imagen (JPG/PNG/SVG).</div>
  {% if form.imagen_url.errors %}<div class="ap-errors">{{ form.imagen_url.errors }}</div>{% endif %}

  {# PREVIEW de la imagen guardada (si existe) #}
  {% if view.object and view.object.imagen %}
    <div class="mt-2">
      <img src="{{ view.object.imagen.url }}" alt="Imagen actual" style="max-width:240px;height:auto;border-radius:8px;">
      <div class="ap-help">Archivo actual: {{ view.object.imagen.name }}</div>
    </div>
  {% endif %}
</div>

{# --- ICONO (URL) --- #}
<div class="ap-field">
  <label class="ap-label" for="{{ form.icono_url.id_for_label }}">{{ form.icono_url.label }}</label>
  {{ form.icono_url }}
  <div class="ap-help">Pegá una <strong>URL</strong> a un SVG/imagen.</div>
  {% if form.icono_url.errors %}<div class="ap-errors">{{ form.icono_url.errors }}</div>{% endif %}

  {# PREVIEW del icono guardado #}
  {% if view.object %}
    {% if view.object.icono and view.object.icono.url %}
      {# icono es File/ImageField #}
      <div class="mt-2">
        <img src="{{ view.object.icono.url }}" alt="Icono actual" style="max-width:120px;height:auto;">
        <div class="ap-help">Archivo actual: {{ view.object.icono.name }}</div>
      </div>
    {% elif view.object.icono %}
      {# icono es Char/URLField (texto con URL) #}
      <div class="mt-2">
        <img src="{{ view.object.icono }}" alt="Icono actual" style="max-width:120px;height:auto;">
        <div class="ap-help">URL actual: {{ view.object.icono }}</div>
      </div>
    {% endif %}
  {% endif %}
</div>


      <div class="ap-actions">
        <a href="{% url 'academics:materia_list' %}" class="ap-btn ap-btn-light">Cancelar</a>
        <button class="ap-btn ap-btn-primary" id="btnSubmit" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    document.querySelectorAll('.ap-field').forEach(function (wrap) {
      if (wrap.querySelector('.ap-errors')) {
        const input = wrap.querySelector('input, select, textarea');
        if (input) input.classList.add('ap-invalid');
      }
    });
  })();
  (function () {
    document.querySelectorAll('textarea').forEach(function (ta) {
      const fit = () => { ta.style.height = 'auto'; ta.style.height = (ta.scrollHeight + 2) + 'px'; };
      ta.addEventListener('input', fit); fit();
    });
  })();
  (function () {
    const form = document.getElementById('matForm');
    const btn = document.getElementById('btnSubmit');
    if (!form || !btn) return;
    form.addEventListener('submit', function () { btn.disabled = true; btn.textContent = 'Guardando...'; });
  })();
</script>
{% endblock %}
